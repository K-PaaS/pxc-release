#!/bin/bash

result=0

MY_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

function get_cpu_count() {
  if [[ "$(uname)" = "Darwin" ]]; then
    sysctl -n hw.ncpu
  else
    nproc
  fi
}

echo -e "\nVetting packages for potential issues..."
#$MY_DIR/govet

echo -e "\nTesting packages..."

# due to the high amount of concurrency in these tests, tests will often fail
# with timeouts if run in parallel on systems with fewer than 4 cores
GINKGO_FLAGS="-r -failOnPending -randomizeAllSpecs -slowSpecThreshold=20 -race"
if [ "$(get_cpu_count)" -ge "4" ]; then
  GINKGO_FLAGS="${GINKGO_FLAGS} -p"
fi

ginkgo ${GINKGO_FLAGS} "$@" $MY_DIR/..
let "result+=$?"

echo -e "\nExit Code: $result"
exit $result
